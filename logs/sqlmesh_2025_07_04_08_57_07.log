2025-07-04 08:57:09,444 - MainThread - sqlmesh.core.config.connection - INFO - Creating new DuckDB adapter for in-memory database (connection.py:453)
2025-07-04 08:57:11,485 - MainThread - sqlmesh.core.plan.evaluator - INFO - Evaluating plan stage CreateSnapshotRecordsStage (evaluator.py:119)
2025-07-04 08:57:11,502 - MainThread - sqlmesh.core.plan.evaluator - INFO - Evaluating plan stage PhysicalLayerUpdateStage (evaluator.py:119)
2025-07-04 08:57:11,505 - ThreadPoolExecutor-1_0 - sqlmesh.core.snapshot.evaluator - INFO - Listing data objects in schema postgres.sqlmesh__kaggle (evaluator.py:350)
2025-07-04 08:57:11,506 - ThreadPoolExecutor-1_1 - sqlmesh.core.snapshot.evaluator - INFO - Listing data objects in schema postgres.sqlmesh__sqlmesh_example (evaluator.py:350)
2025-07-04 08:57:11,512 - ThreadPoolExecutor-1_0 - sqlmesh.core.engine_adapter.base - INFO - Executing SQL: SELECT current_catalog (base.py:2244)
2025-07-04 08:57:11,521 - ThreadPoolExecutor-1_1 - sqlmesh.core.engine_adapter.base - INFO - Executing SQL: SELECT current_catalog (base.py:2244)
2025-07-04 08:57:11,540 - MainThread - sqlmesh.core.snapshot.evaluator - INFO - Creating schema 'postgres.sqlmesh__kaggle' (evaluator.py:1143)
2025-07-04 08:57:11,549 - MainThread - sqlmesh.core.engine_adapter.base - INFO - Executing SQL: CREATE SCHEMA IF NOT EXISTS "sqlmesh__kaggle" (base.py:2244)
2025-07-04 08:57:11,550 - MainThread - sqlmesh.core.snapshot.evaluator - INFO - Creating schema 'postgres.sqlmesh__sqlmesh_example' (evaluator.py:1143)
2025-07-04 08:57:11,550 - MainThread - sqlmesh.core.engine_adapter.base - INFO - Executing SQL: CREATE SCHEMA IF NOT EXISTS "sqlmesh__sqlmesh_example" (base.py:2244)
2025-07-04 08:57:11,562 - ThreadPoolExecutor-2_0 - sqlmesh.core.snapshot.evaluator - INFO - Creating table 'postgres.sqlmesh__kaggle.kaggle__kaggle_data_model__2175441484' (evaluator.py:1495)
2025-07-04 08:57:11,563 - ThreadPoolExecutor-2_0 - sqlmesh.core.engine_adapter.base - INFO - Executing SQL: CREATE TABLE IF NOT EXISTS "sqlmesh__kaggle"."kaggle__kaggle_data_model__2175441484" ("store_number" INT, "date" TIMESTAMP, "weekly_sales" DOUBLE PRECISION, "holiday_flag" INT, "temperature" DOUBLE PRECISION, "fuel_price" DOUBLE PRECISION, "cpi" INT, "unemployment" DOUBLE PRECISION) (base.py:2244)
2025-07-04 08:57:11,575 - MainThread - sqlmesh.core.plan.evaluator - INFO - Evaluating plan stage BackfillStage (evaluator.py:119)
2025-07-04 08:57:11,578 - ThreadPoolExecutor-3_0 - sqlmesh.core.snapshot.evaluator - INFO - Evaluating snapshot SnapshotId<"postgres"."kaggle"."kaggle_data_model": 31277838> (evaluator.py:636)
2025-07-04 08:57:13,025 - MainThread - sqlmesh.core.scheduler - INFO - Execution failed for node ('"postgres"."kaggle"."kaggle_data_model"', ((1751414400000, 1751500800000), 0)) (scheduler.py:483)
Traceback (most recent call last):
  File "/home/hq0x/github/postgres/venv/lib/python3.12/site-packages/pandas/core/indexes/base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'weekly_sales'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/hq0x/github/postgres/venv/lib/python3.12/site-packages/sqlmesh/core/model/definition.py", line 1789, in render
    df_or_iter = env[self.entrypoint](
                 ^^^^^^^^^^^^^^^^^^^^^
  File "<string>", line 14, in execute
  File "/home/hq0x/github/postgres/venv/lib/python3.12/site-packages/pandas/core/frame.py", line 4107, in __getitem__
    indexer = self.columns.get_loc(key)
              ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/hq0x/github/postgres/venv/lib/python3.12/site-packages/pandas/core/indexes/base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'weekly_sales'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/hq0x/github/postgres/venv/lib/python3.12/site-packages/sqlmesh/utils/concurrency.py", line 69, in _process_node
    self.fn(node)
  File "/home/hq0x/github/postgres/venv/lib/python3.12/site-packages/sqlmesh/core/scheduler.py", line 442, in evaluate_node
    audit_results = self.evaluate(
                    ^^^^^^^^^^^^^^
  File "/home/hq0x/github/postgres/venv/lib/python3.12/site-packages/sqlmesh/core/scheduler.py", line 183, in evaluate
    wap_id = self.snapshot_evaluator.evaluate(
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/hq0x/github/postgres/venv/lib/python3.12/site-packages/sqlmesh/core/snapshot/evaluator.py", line 159, in evaluate
    result = self._evaluate_snapshot(
             ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/hq0x/github/postgres/venv/lib/python3.12/site-packages/sqlmesh/core/snapshot/evaluator.py", line 787, in _evaluate_snapshot
    for index, query_or_df in enumerate(queries_or_dfs):
  File "/home/hq0x/github/postgres/venv/lib/python3.12/site-packages/sqlmesh/core/model/definition.py", line 1800, in render
    raise PythonModelEvalError(format_evaluated_code_exception(e, self.python_env))
sqlmesh.utils.errors.PythonModelEvalError:   File "/home/hq0x/github/postgres/venv/lib/python3.12/site-packages/pandas/core/indexes/base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc

  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc

  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item

  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item

  KeyError: 'weekly_sales'


The above exception was the direct cause of the following exception:


  File 'models/kaggle_walmart_sales.py' (or imported file), line 14, in execute
    def execute(context: ExecutionContext, start: datetime, end: datetime,
        execution_time: datetime, **kwargs: t.Any):
        dataset = 'michaelhakim/walmart-sales-analysis'
        kaggle.api.authenticate()
        tmp_dir = '/tmp/kaggle_download'
        os.makedirs(tmp_dir, exist_ok=True)
        kaggle.api.dataset_download_files(dataset, path=tmp_dir, unzip=True,
            quiet=True)
        csv_files = [f for f in os.listdir(tmp_dir) if f.endswith('.csv')]
        if not csv_files:
            raise FileNotFoundError('No CSV found in the Kaggle dataset download.')
        csv_path = os.path.join(tmp_dir, csv_files[0])
        df = pd.read_csv(csv_path)
        df['weekly_sales'] = pd.to_numeric(df['weekly_sales'], errors='coerce')
    File "/home/hq0x/github/postgres/venv/lib/python3.12/site-packages/pandas/core/frame.py", line 4107, in __getitem__
    indexer = self.columns.get_loc(key)
              ^^^^^^^^^^^^^^^^^^^^^^^^^

    File "/home/hq0x/github/postgres/venv/lib/python3.12/site-packages/pandas/core/indexes/base.py", line 3819, in get_loc
    raise KeyError(key) from err

      KeyError: 'weekly_sales'


The above exception was the direct cause of the following exception:

sqlmesh.utils.concurrency.NodeExecutionFailedError: Execution failed for node ('"postgres"."kaggle"."kaggle_data_model"', ((1751414400000, 1751500800000), 0))
2025-07-04 08:57:13,035 - MainThread - sqlmesh.core.context - INFO - Plan application failed. (context.py:1607)
Traceback (most recent call last):
  File "/home/hq0x/github/postgres/venv/lib/python3.12/site-packages/sqlmesh/core/context.py", line 1599, in apply
    self._apply(plan, circuit_breaker)
  File "/home/hq0x/github/postgres/venv/lib/python3.12/site-packages/sqlmesh/core/context.py", line 2392, in _apply
    self._scheduler.create_plan_evaluator(self).evaluate(
  File "/home/hq0x/github/postgres/venv/lib/python3.12/site-packages/sqlmesh/core/plan/evaluator.py", line 102, in evaluate
    self._evaluate_stages(plan_stages, plan)
  File "/home/hq0x/github/postgres/venv/lib/python3.12/site-packages/sqlmesh/core/plan/evaluator.py", line 121, in _evaluate_stages
    handler(stage, plan)
  File "/home/hq0x/github/postgres/venv/lib/python3.12/site-packages/sqlmesh/core/plan/evaluator.py", line 242, in visit_backfill_stage
    raise PlanError("Plan application failed.")
sqlmesh.utils.errors.PlanError: Plan application failed.
2025-07-04 08:57:13,037 - MainThread - root - INFO - Shutting down the event dispatcher (dispatcher.py:159)
